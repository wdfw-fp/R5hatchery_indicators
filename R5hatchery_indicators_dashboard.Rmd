---
title: "Interactive Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
---

```{r}
# Load required libraries
pacman::p_load(shiny, tidyverse, ggplot2, leaflet)

# Load your data (replace this with your actual data loading code)
populations_LUT <- read_csv("results/populations_LUT.csv") %>%
  dplyr::rename(population = esa_pop_name)

indicators <- read_csv("results/indicators_NOAA_pop.csv") %>%
  dplyr::rename(population = esa_pop_name) %>%
  left_join(populations_LUT)

# Shiny app
shinyApp(
  ui = fluidPage(
    # Shiny UI components
    selectInput("species", "Select Species", choices = c("None", unique(indicators$species)), multiple = FALSE),
    selectInput("run", "Select Run", choices = c("None", unique(indicators$run)), multiple = FALSE),
    selectInput("population", "Select Population", choices = c("None", unique(indicators$population)), multiple = FALSE),
    downloadButton("downloadData", "Download Data"),
    plotOutput("plot")  # This creates a placeholder for the plot
  ),

  server = function(input, output, session) {
  # Set initial values to NULL
  updateSelectInput(session, "species", selected = "None")
  updateSelectInput(session, "run", selected = "None")
  updateSelectInput(session, "population", selected = "None")

  # Reactive values
  subset_data_reactive <- reactive({
    indicators %>%
      filter(
        if (input$species != "None") species == input$species else TRUE,
        if (input$run != "None") run == input$run else TRUE,
        if (input$population != "None") population == input$population else TRUE
      ) %>%
      dplyr::select(
        Brood_Year, species, run, population, NMFS_POPID, NOSA, TSA,
        pNOB, pHOS, pNI, total_releases = total
      ) %>%
      pivot_longer(
        values_to = "value",
        names_to = "indicator",
        cols = c(NOSA, TSA, pHOS, pNOB, pNI, total_releases)
      ) %>%
      mutate(indicator = factor(indicator, levels = c("NOSA", "TSA", "pHOS", "pNOB", "pNI", "total_releases")))
  })

  observe({
    species_population_filtered <- indicators %>%
      filter(if (input$species != "None") species == input$species else TRUE) %>%
      filter(if (input$population != "None") population == input$population else TRUE)
    updateSelectInput(session, "run", choices = c("None", unique(species_population_filtered$run)), selected = if (input$run != "None") input$run else "None")
  })

  observe({
    run_population_filtered <- indicators %>%
      filter(if (input$run != "None") run == input$run else TRUE) %>%
      filter(if (input$population != "None") population == input$population else TRUE)
    updateSelectInput(session, "species", choices = c("None", unique(run_population_filtered$species)), selected = if (input$species != "None") input$species else "None")
  })

  observe({
    run_species_filtered <- indicators %>%
      filter(if (input$run != "None") run == input$run else TRUE) %>%
      filter(if (input$species != "None") species == input$species else TRUE)
    updateSelectInput(session, "population", choices = c("None", unique(run_species_filtered$population)), selected = if (input$population != "None") input$population else "None")
  })

  # Render plot
  output$plot <- renderPlot({
    cat("Selected species:", input$species, "\n")
    cat("Selected run:", input$run, "\n")
    cat("Selected population:", input$population, "\n")

    # Plotting code
    filtered_data <- subset_data_reactive()
    # Check the number of unique populations in the filtered data
    unique_populations <- unique(filtered_data$population)

    if (length(unique_populations) == 1) {
      facet_limits <- filtered_data %>%
        group_by(indicator, species) %>%
        mutate(
          minBY = min(Brood_Year),
          maxBY = max(Brood_Year),
          min = 0,
          max = max(value, na.rm = TRUE, nan.rm = TRUE)
        ) %>%
        distinct(minBY, maxBY, min, max) %>%
        pivot_longer(cols = c(minBY, maxBY), values_to = "Brood_Year", names_to = "type") %>%
        pivot_longer(cols = c(min, max), values_to = "value", names_to = "type2") %>%
        dplyr::select(-c(type, type2))

      current_plot <- ggplot(filtered_data, aes(x = Brood_Year, y = value, color = species)) +
        geom_line() +
        geom_point() +
        ylim(0, NA) +
        theme_bw() +
        theme(plot.title = element_text(size = 12)) +
        facet_wrap(~indicator, nrow = 6, scales = "free_y") +
        ggtitle("shit") +
        geom_blank(data = facet_limits, aes(x = Brood_Year, y = value))

      print(current_plot)
    } else {
      print("Please select only one population to generate the plot.")
    }
  }, height = 600, width = 800)

  # Download handler
    output$downloadData <- downloadHandler(
      filename = function() {
        paste("salmon_indicator_data_", Sys.Date(), ".csv", sep = "")
      },
      content = function(file) {
        req(subset_data_reactive())
        write.csv(subset_data_reactive(), file, row.names = FALSE)
      }
    )
  }

)

```